#!/bin/bash
# =============================================================================
# Let's Encrypt SSL ì¸ì¦ì„œ ì„¤ì • ìŠ¤í¬ë¦½íŠ¸
# 
# ì‚¬ìš©ë²•:
#   ./setup-ssl.sh your-domain.com your-email@example.com
#
# ì˜ˆì‹œ:
#   ./setup-ssl.sh diary.example.com admin@example.com
# =============================================================================

set -e

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# =============================================================================
# 1. ì¸ì í™•ì¸
# =============================================================================
DOMAIN=$1
EMAIL=$2

if [ -z "$DOMAIN" ]; then
    echo -e "${RED}âŒ ì˜¤ë¥˜: ë„ë©”ì¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.${NC}"
    echo "ì‚¬ìš©ë²•: ./setup-ssl.sh <ë„ë©”ì¸> <ì´ë©”ì¼>"
    echo "ì˜ˆì‹œ:   ./setup-ssl.sh diary.example.com admin@example.com"
    exit 1
fi

if [ -z "$EMAIL" ]; then
    echo -e "${RED}âŒ ì˜¤ë¥˜: ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.${NC}"
    echo "ì‚¬ìš©ë²•: ./setup-ssl.sh <ë„ë©”ì¸> <ì´ë©”ì¼>"
    echo "ì˜ˆì‹œ:   ./setup-ssl.sh diary.example.com admin@example.com"
    exit 1
fi

echo -e "${GREEN}ğŸ” SSL ì¸ì¦ì„œ ì„¤ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤...${NC}"
echo "   ë„ë©”ì¸: $DOMAIN"
echo "   ì´ë©”ì¼: $EMAIL"
echo ""

# =============================================================================
# 2. Certbot ì„¤ì¹˜ í™•ì¸
# =============================================================================
echo "ğŸ“¦ Certbot ì„¤ì¹˜ í™•ì¸ ì¤‘..."

if ! command -v certbot &> /dev/null; then
    echo "Certbotì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì¹˜ ì¤‘..."
    sudo apt-get update
    sudo apt-get install -y certbot python3-certbot-nginx
    echo -e "${GREEN}âœ… Certbot ì„¤ì¹˜ ì™„ë£Œ${NC}"
else
    echo -e "${GREEN}âœ… Certbotì´ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.${NC}"
fi

# =============================================================================
# 3. ë””ë ‰í† ë¦¬ ìƒì„±
# =============================================================================
echo "ğŸ“ SSL ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."

SSL_DIR="$(dirname "$0")/../nginx/ssl"
CERTBOT_WWW="/var/www/certbot"

mkdir -p "$SSL_DIR"
sudo mkdir -p "$CERTBOT_WWW"

echo -e "${GREEN}âœ… ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ${NC}"

# =============================================================================
# 4. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ (ì¸ì¦ì„œ ë°œê¸‰ì„ ìœ„í•´ 80ë²ˆ í¬íŠ¸ í•„ìš”)
# =============================================================================
echo "ğŸ³ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."

cd "$(dirname "$0")/.."
docker-compose -f docker-compose.prod.yml down 2>/dev/null || true

echo -e "${GREEN}âœ… ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì™„ë£Œ${NC}"

# =============================================================================
# 5. SSL ì¸ì¦ì„œ ë°œê¸‰
# =============================================================================
echo "ğŸ” SSL ì¸ì¦ì„œ ë°œê¸‰ ì¤‘..."
echo -e "${YELLOW}   ì´ ê³¼ì •ì€ ëª‡ ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤...${NC}"

sudo certbot certonly \
    --standalone \
    --preferred-challenges http \
    --agree-tos \
    --no-eff-email \
    --email "$EMAIL" \
    -d "$DOMAIN"

echo -e "${GREEN}âœ… SSL ì¸ì¦ì„œ ë°œê¸‰ ì™„ë£Œ${NC}"

# =============================================================================
# 6. ì¸ì¦ì„œ ë³µì‚¬ (nginx ë³¼ë¥¨ ë§ˆìš´íŠ¸ìš©)
# =============================================================================
echo "ğŸ“‹ ì¸ì¦ì„œ ë³µì‚¬ ì¤‘..."

sudo cp /etc/letsencrypt/live/$DOMAIN/fullchain.pem "$SSL_DIR/fullchain.pem"
sudo cp /etc/letsencrypt/live/$DOMAIN/privkey.pem "$SSL_DIR/privkey.pem"
sudo chmod 644 "$SSL_DIR"/*.pem

echo -e "${GREEN}âœ… ì¸ì¦ì„œ ë³µì‚¬ ì™„ë£Œ${NC}"

# =============================================================================
# 7. nginx ì„¤ì • íŒŒì¼ì˜ ë„ë©”ì¸ ì—…ë°ì´íŠ¸
# =============================================================================
echo "ğŸ“ nginx ì„¤ì • ì—…ë°ì´íŠ¸ ì¤‘..."

NGINX_CONF="$(dirname "$0")/../nginx/nginx.conf"
sed -i "s/your-domain.com/$DOMAIN/g" "$NGINX_CONF"

echo -e "${GREEN}âœ… nginx ì„¤ì • ì—…ë°ì´íŠ¸ ì™„ë£Œ${NC}"

# =============================================================================
# 8. ìë™ ê°±ì‹  cron job ì„¤ì •
# =============================================================================
echo "â° ìë™ ê°±ì‹  ì„¤ì • ì¤‘..."

# ê¸°ì¡´ cron job ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€
(crontab -l 2>/dev/null | grep -v "certbot renew") | crontab -
(crontab -l 2>/dev/null; echo "0 3 * * * certbot renew --quiet --post-hook \"docker-compose -f ~/app/docker-compose.prod.yml exec nginx nginx -s reload\"") | crontab -

echo -e "${GREEN}âœ… ìë™ ê°±ì‹  ì„¤ì • ì™„ë£Œ (ë§¤ì¼ ì˜¤ì „ 3ì‹œ ì²´í¬)${NC}"

# =============================================================================
# 9. ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
# =============================================================================
echo "ğŸ³ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì¤‘..."

docker-compose -f docker-compose.prod.yml up -d

echo -e "${GREEN}âœ… ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì™„ë£Œ${NC}"

# =============================================================================
# ì™„ë£Œ
# =============================================================================
echo ""
echo "============================================="
echo -e "${GREEN}âœ… SSL ì¸ì¦ì„œ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!${NC}"
echo "============================================="
echo ""
echo "ğŸ“‹ ì„¤ì • ì •ë³´:"
echo "   ë„ë©”ì¸: https://$DOMAIN"
echo "   ì¸ì¦ì„œ ìœ„ì¹˜: /etc/letsencrypt/live/$DOMAIN/"
echo "   nginx ì¸ì¦ì„œ ë³µì‚¬ë³¸: $SSL_DIR/"
echo ""
echo "ğŸ”„ ì¸ì¦ì„œ ê°±ì‹ :"
echo "   - ìë™ ê°±ì‹ ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤ (ë§¤ì¼ ì˜¤ì „ 3ì‹œ ì²´í¬)"
echo "   - ìˆ˜ë™ ê°±ì‹ : sudo certbot renew"
echo ""
echo "ğŸ§ª í…ŒìŠ¤íŠ¸:"
echo "   curl -I https://$DOMAIN"
echo "   SSL ë“±ê¸‰ í™•ì¸: https://www.ssllabs.com/ssltest/analyze.html?d=$DOMAIN"
echo ""
